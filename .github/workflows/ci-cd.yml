name: End-to-End DevOps EKS Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      TF_LOCK_TABLE: ${{ secrets.TF_LOCK_TABLE }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      IMAGE_NAME: devops-eks-project-repo
      SKIP_BOOTSTRAP: true

    steps:
    # -------------------------------------------------
    # Checkout Code
    # -------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -------------------------------------------------
    # Install Terraform
    # -------------------------------------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    # -------------------------------------------------
    # AWS Authentication
    # -------------------------------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # -------------------------------------------------
    # Terraform Bootstrap (optional)
    # -------------------------------------------------
    - name: Debug backend values
      if: env.SKIP_BOOTSTRAP != 'true'
      run: |
        printf "Bucket=[%s]\n" "$TF_STATE_BUCKET"
        printf "Table=[%s]\n" "$TF_LOCK_TABLE"

    - name: Terraform Bootstrap Init
      if: env.SKIP_BOOTSTRAP != 'true'
      run: |
        cd terraform/bootstrap
        terraform init

    - name: Terraform Bootstrap Apply
      if: env.SKIP_BOOTSTRAP != 'true'
      run: |
        cd terraform/bootstrap
        terraform apply -auto-approve \
          -var="state_bucket_name=$TF_STATE_BUCKET" \
          -var="lock_table_name=$TF_LOCK_TABLE"

    # -------------------------------------------------
    # Terraform Main Infra
    # -------------------------------------------------
    - name: Terraform Init (Main)
      run: |
        cd terraform
        terraform init

    - name: Terraform Apply (Main)
      run: |
        cd terraform
        terraform apply -auto-approve

    # -------------------------------------------------
    # ECR Login
    # -------------------------------------------------
    - name: Login to Amazon ECR
      run: |
        aws ecr get-login-password --region $AWS_REGION \
        | docker login \
          --username AWS \
          --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

    # -------------------------------------------------
    # Build Docker Image
    # -------------------------------------------------
    - name: Build Docker Image
      run: |
        docker build \
          -t $IMAGE_NAME:latest \
          -f docker/Dockerfile .

    # -------------------------------------------------
    # Tag & Push Image
    # -------------------------------------------------
    - name: Tag & Push Docker Image
      run: |
        docker tag $IMAGE_NAME:latest \
          $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest

        docker push \
          $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest

    # -------------------------------------------------
    # Update kubeconfig
    # -------------------------------------------------
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region $AWS_REGION \
          --name $EKS_CLUSTER_NAME

    # -------------------------------------------------
    # WAIT FOR RBAC (CRITICAL FIX)
    # -------------------------------------------------
    - name: Wait for EKS RBAC propagation
      run: |
        echo "Waiting for EKS RBAC to be ready..."
        for i in {1..10}; do
          kubectl auth can-i get pods && break
          echo "RBAC not ready yet... retrying"
          sleep 15
        done

    # -------------------------------------------------
    # Deploy Kubernetes Manifests
    # -------------------------------------------------
    - name: Deploy Kubernetes Manifests
      run: |
        export AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
        export AWS_REGION=${{ secrets.AWS_REGION }}

        kubectl apply -f k8s/namespace.yaml --validate=false
        envsubst < k8s/deployment.yaml | kubectl apply -f - --validate=false
        kubectl apply -f k8s/service.yaml --validate=false
        kubectl apply -f k8s/ingress.yaml --validate=false

    # -------------------------------------------------
    # Verify Deployment
    # -------------------------------------------------
    - name: Verify Deployment
      run: |
        kubectl get pods -n devops
        kubectl get svc -n devops
        kubectl get ingress -n devops
