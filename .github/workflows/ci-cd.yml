name: End-to-End DevOps EKS Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      TF_LOCK_TABLE: ${{ secrets.TF_LOCK_TABLE }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      IMAGE_NAME: devops-eks-project-repo
      SKIP_BOOTSTRAP: true

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Terraform
      # -------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # -------------------------------------------------
      # AWS Credentials
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -------------------------------------------------
      # Verify IAM Identity
      # -------------------------------------------------
      - name: Verify IAM Identity
        run: |
          echo "Current IAM identity:"
          aws sts get-caller-identity
          echo "Expected: arn:aws:iam::505679504503:user/deploy"

      # -------------------------------------------------
      # Terraform Apply
      # -------------------------------------------------
      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve

      # -------------------------------------------------
      # Wait for EKS cluster to be fully ready
      # -------------------------------------------------
      - name: Wait for EKS cluster to be ready
        run: |
          echo "Waiting for EKS cluster to be fully operational..."
          aws eks wait cluster-active --name $EKS_CLUSTER_NAME --region $AWS_REGION
          echo "✅ EKS cluster is active"

      # -------------------------------------------------
      # Wait for EKS Access Entry
      # -------------------------------------------------
      - name: Wait for EKS access entry
        run: |
          echo "Waiting for EKS access entry to propagate..."
          sleep 30
          
          echo "Verifying access entry exists..."
          aws eks describe-access-entry \
            --cluster-name $EKS_CLUSTER_NAME \
            --principal-arn arn:aws:iam::505679504503:user/deploy \
            --region $AWS_REGION
          
          echo "Listing all access entries..."
          aws eks list-access-entries \
            --cluster-name $EKS_CLUSTER_NAME \
            --region $AWS_REGION

      # -------------------------------------------------
      # Update kubeconfig
      # -------------------------------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER_NAME

      # -------------------------------------------------
      # Test Kubernetes Authentication
      # -------------------------------------------------
      - name: Test Kubernetes Authentication
        run: |
          echo "Testing kubectl authentication..."
          for i in {1..12}; do
            if kubectl auth can-i get namespaces 2>/dev/null; then
              echo "✅ Authentication successful"
              kubectl get nodes
              break
            else
              echo "⏳ Waiting for authentication... attempt $i/12"
              sleep 15
            fi
          done
          
          # Final verification
          kubectl auth can-i get namespaces || {
            echo "❌ Authentication failed after waiting"
            echo "Cluster info:"
            kubectl cluster-info
            exit 1
          }

      # -------------------------------------------------
      # ECR Login
      # -------------------------------------------------
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password \
          | docker login \
            --username AWS \
            --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # -------------------------------------------------
      # Build & Push Image
      # -------------------------------------------------
      - name: Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:latest -f docker/Dockerfile .

      - name: Push Docker Image
        run: |
          docker tag $IMAGE_NAME:latest \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest
          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest

      # -------------------------------------------------
      # Deploy Manifests
      # -------------------------------------------------
      - name: Deploy Kubernetes Manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          envsubst < k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      # -------------------------------------------------
      # Verify
      # -------------------------------------------------
      - name: Verify Deployment
        run: |
          kubectl get pods -n devops
          kubectl get svc -n devops
          kubectl get ingress -n devops