name: End-to-End DevOps EKS Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      TF_LOCK_TABLE: ${{ secrets.TF_LOCK_TABLE }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      IMAGE_NAME: devops-eks-project-repo
      SKIP_BOOTSTRAP: true
      ADMIN_ARN: arn:aws:iam::505679504503:user/terraadmin

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Terraform
      # -------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      # -------------------------------------------------
      # AWS Credentials
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -------------------------------------------------
      # Verify IAM Identity
      # -------------------------------------------------
      - name: Verify IAM Identity
        run: |
          echo "Current IAM identity:"
          CURRENT_ARN=$(aws sts get-caller-identity --query Arn --output text)
          echo "Current: $CURRENT_ARN"
          echo "Expected: $ADMIN_ARN"
          
          if [ "$CURRENT_ARN" != "$ADMIN_ARN" ]; then
            echo "❌ ERROR: IAM identity mismatch!"
            exit 1
          fi
          echo "✅ IAM identity matches"

      # -------------------------------------------------
      # Terraform Init
      # -------------------------------------------------
      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      # -------------------------------------------------
      # Check Terraform State for Access Entry
      # -------------------------------------------------
      - name: Check Terraform State
        run: |
          cd terraform
          echo "=== Checking Terraform State ==="
          terraform state list | grep -i access || echo "⚠️  No access entry resources in state"
          
          echo ""
          echo "=== Checking what Terraform knows about access entry ==="
          if terraform state list | grep -q "module.eks.aws_eks_access_entry.admin"; then
            echo "Found access entry in state, showing details:"
            terraform state show module.eks.aws_eks_access_entry.admin
          else
            echo "❌ Access entry NOT in Terraform state"
          fi

      # -------------------------------------------------
      # Check AWS for Access Entry
      # -------------------------------------------------
      - name: Check AWS for Access Entry
        run: |
          echo "=== Checking AWS EKS for access entries ==="
          CURRENT_ARN=$(aws sts get-caller-identity --query Arn --output text)
          
          echo "All access entries in cluster:"
          aws eks list-access-entries \
            --cluster-name $EKS_CLUSTER_NAME \
            --region $AWS_REGION || echo "Failed to list access entries"
          
          echo ""
          echo "Checking if $CURRENT_ARN has access:"
          aws eks describe-access-entry \
            --cluster-name $EKS_CLUSTER_NAME \
            --principal-arn "$CURRENT_ARN" \
            --region $AWS_REGION 2>&1 || echo "Access entry does NOT exist in AWS"

      # -------------------------------------------------
      # Terraform Apply with Retry
      # -------------------------------------------------
      - name: Terraform Apply
        run: |
          cd terraform
          
          for i in {1..3}; do
            echo "Terraform apply attempt $i/3..."
            